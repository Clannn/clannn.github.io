# 游戏引擎架构

## 操作系统基础

### 进程

​	进程是操作系统管理程序的**运行实例**的方法，程序包含在一个可执行文件中。只有程序实际运行时对应的进程才会存在。一个进程包括：

- 进程标识符（PID），在操作系统中唯一地标识进程。
- 一组权限，例如哪个用户“拥有”，用户读写权限。
- 父进程的引用（如果有的话）。
- 包含物理内存“视图”的虚拟内存空间
- 所有环境变量的值
- 所有打开的文件句柄
- 当前工作目录
- 用于管理进程之间通信和同步的资源，例如消息队列、管道和信号量
- 一个或多个线程

​	线程是封装了单个指令流的运行实例。初始状态下，一个进程包含一个线程，可以在进程中创建多个线程。操作系统内核调度系统中所有的线程（来自所有正在运行的进程）在可用的CPU核心上运行。使用抢占式多任务调度在线程之间切换。**线程是操作系统中程序执行的基本单位，**进程只是提供了一个环境以供进程中的线程运行，包括一个虚拟内存映射和一组资源，这些资源由该进程中的所有线程共享。当一个线程在核心上运行时，它的进程会变为运行态，**线程总是在一个进程的上下文中运行。**

#### 进程的虚拟内存映射

​	程序以虚拟地址的方式访问内存，CPU和操作系统合作将虚拟地址重新映射为物理地址。重映射是通过“页面”进行的，操作系统使用“页表”将虚拟页面索引映射到物理页面索引。**每一个进程都有它自己的虚拟页表。**除非显式的共享页面，否则两个进程映射到的物理页面不会有交集。操作系统内核的页面映射到被称为内核空间的特殊地址范围，这个地址范围只能被内核态下运行的程序访问。<u>内存映射通常包含</u>：

- 从程序的可执行文件读入的代码、数据和BSS段
- 程序使用的任何共享库（DLLs）视图
- 每个线程的调用栈
- 用于动态分配内存的堆内存区域
- 与其他进程共享的内存页
- 进程无法访问的内核空间地址范围（当发生内核调用时变得可访问）

**代码、数据和BSS段**

​	当程序第一次运行时，操作系统内核创建一个进程并为它分配一个唯一的PID，然后内核为进程创建一个虚拟地址空间，再按需分配物理页面并填充程序的页表。内核将可执行文件（代码、数据和BSS段）读取到虚拟内存中。

**调用栈**

​	每个运行的线程都需要一个调用栈，内核为这个调用栈分配虚拟内存。栈指针（SP）和基指针（BP）的值被初始化为指向空栈的底部。进程第一次运行时会为它创建一个默认线程，然后线程从程序的入口点开始执行。

**堆**

​	当进程动态分配内存时，新的物理页面被映射到虚拟地址空间中，内容已完全释放的页面将被解除映射并返回给操作系统。