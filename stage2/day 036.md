# CMake

​	CMake指令存放在名为`CMakeLists.txt`的文件中，该文件名称区分大小写，最简单的CMake指令为：

```cmake
# 声明CMake所需的最低版本
cmake_minimum_required(VERSION 3.5 FATAL_ERROR)

# 声明项目名称和所支持的编程语言
project(recipe-01 LANGUAGES CXX)

# 创建一个新“目标”：可执行文件hello-world，该可执行文件通过编译链接源文件hello-world.cpp生成，CMake将为编译器使用默认设置，并自动选择生成工具
add_executable(hello-world hello-world.cpp)
```

​	要配置项目并生成构建器，需要调用`cmake`指令并传入`CMakeLists.txt`的所在路径，通常为：`cmake -Bbuild .`；要构建项目，则需要运行`cmake --build ./build/`。

​	可以通过`add_library`函数创建新“目标”：库，如下所示：

```cmake
add_library(message STATIC
	Message.hpp
	Message.cpp
)

add_excutable(hello-world hello-world.cpp)

# 将目标库(message)链接到可执行文件
target_link_libraries(hello-world message)
```

`add_library`的第一个参数是目标名称，在整个`CMakeLists.txt`中，都可以使用相同的名称来引用库。第二个参数表示库的类型，通常有：

- `STATIC`：创建静态库(.lib)，即编译文件的打包存档

- `SHARED`：创建动态库(.dll)，即在运行时加载的库

- `OBJECT`：将`add_library`参数列表中的源码文件编译到目标文件(.o)，但它们不属于静态库也不属于动态库，如果需要同时创建静态库和动态库，则`OBJECT`库非常有用，如下所示：

  ```cm
  add_library(message-objs OBJECT
  	Message.hpp
  	Message.cpp
  )
  
  add_library(message-shared SHARED
  	$<TARGET_OBJECTS:message-objs>
  )
  
  add_library(message-static STATIC
  	$<TARGET_OBJECTS:message-objs>
  )
  ```

- `MODULE`：又称DSO库，它可以动态加载，但不链接到项目中的任何目标，主要用于构建运行时插件

- `IMPORTED`：此类库表示位于项目外部的库，主要用于对现有依赖项进行构建

可以通过`set`指令来创建或设置全局变量的值：

```cmake
# 创建全局变量并赋值
set(USE_LIBRARY OFF)

# 设置全局变量的值
set(BUILD_SHARED_LIBS OFF)

# 局部变量 _sources
list(APPEND _source Message.h Message.cpp)
```

`BUILD_SHARED_LIBS`变量是CMake的一个全局标志，`add_library`可以在不提供`STATIC/SHARED/OBJECT`参数的情况下调用，此时，CMake内部查询`BUILD_SHARED_LIBS`的值，如果为`false`或未定义，则生成一个静态库。

逻辑为真的值可以是：`1`、`ON`、`YES`、`true`、`Y`或任何非零数

逻辑为假的值可以是：`0`、`OFF`、`NO`、`false`、`N`、`IGNORE`、`NOTFOUND`或空字符串

可以在`CMakeLists.txt`中使用`option()`命令，以选项的形式显示逻辑开关，并用于外部设置。如下所示：

```cmake
## option(<option_variable> "help string" [initial value])
option(USE_LIBRARY "Compile sources into a library" OFF)
```

现在，便可以通过`cmake`指令的`-D`选项，将信息传递给`cmake`：

```bash
cmake -D USE_LIBRARY=ON -Bbuild .
```

`-D`选项可以用来设置任何类型的变量。

CMake将语言的编译器存储在`CMAKE_<LANG>_COMPILER`变量中，可以通过`-D`选项改变它的值，比如：`cmake -D CMAKE_CXX_COMPILER=g++ -Bbuild .`

