review: 007 010 012 013

# Game Engine Architecture

## Data, Code and Memory Layout

​	当声明数据结构时，认真对待对齐和包裹是一个好习惯。

![image-20220824145834744](C:\Users\Clan\OneDrive\桌面\study\研一\studys\day by day\pictures\image-20220824145834744.png)

![image-20220824145847388](C:\Users\Clan\AppData\Roaming\Typora\typora-user-images\image-20220824145847388.png)

​	整个结构的大小是20字节，编译器在末端加上了两个字节作为填充。有了这个填充，若定义该结构的数组类型时，只要首元素对其，之后的所有数组元素都是对齐的。可以在结构的末端加上明确的填充，如`U8 _pad[2];`，使浪费的空间更加清晰。

#### C++类的内存布局

​	当B类继承自A类时，内存里B类的数据成员会紧接着A类的数据成员之后。请完全避免多重继承！

​	当类含有或继承了一个或多个*虚函数* 时，那么在类内存布局的最前端会添加4字节（若目标硬件为64位则是8字节）指针，称为虚表指针。该指针指向名为虚函数表的数据结构。每个类的虚表里，都包含该类声明或继承的所有虚函数指针。每个（含虚函数的）具体类都具有一个虚函数表，这些类的实例都会有虚表指针指向该虚函数表。

​	假设有一个指向`shape`类型的指针，要调用其虚函数`Draw()`，代码可以先对其虚表指针解引用，取得虚函数表，再从表中找出`Draw()`条目，即可调用。

### Computer Hardware Fundamentals

### CPU

​	The CPU consists of the following components:

- an *arithmetic/logic unit* (ALU) for performing integer arithmetic and bit shifting,
- a *floating-point unit* (FPU) for doing floating-point arithmetic,
- modern CPUs also contain a *vector processing unit* (VPU) which is capable of performing floating-point and integer operations on multiple data items in parallel,
- a *memory controller* (MC) for interfacing with on-chip and off-chip memory devices,
- a bank of *registers*
- a *control unit* (CU) for decoding and dispatching machine language instructions

![image-20220824155739980](C:\Users\Clan\OneDrive\桌面\study\研一\studys\day by day\pictures\image-20220824155739980.png)

​	All of these components are driven by a periodic square wave signal known as the *clock*.

#### ALU

​	The ALU performs arithmetic operations such as addition, subtraction, multiplication and division, and also performs logical operations such as AND, OR, exclusive OR.

​	An ALU typically performs integer operations only.

#### VPU

​	VPU can typically perform both integer and floating-point arithmetic. It apply arithmetic operators to vectors of input data—between $2$ and $16$ floating-point values or up to 64 integer values.

​	Vector processing is also known as *single instruction multiple data* (SIMD).

​	Today’s CPUs don’t actually contain an FPU. Instead, all floating-point calculations are performed by the VPU. Optimizing compilers will typically convert math performed on float variables into *vectorized* code that uses the VPU anyway.

#### Registers

​	An ALU or FPU can usually only perform calculations on data that exists in *registers*. Because registers aren’t part of main memory, they typically don’t have addresses but they do have names, such as `AX`, `BX`, `CX` and `DX`.

​	Every CPU also contains a number of *special-purpose registers* (SPR). These include:

- the *instruction pointer* (IP),
- the *stack pointer* (SP),
- the *base pointer* (BP) and
- the *status register*.

***Instruction Pointer***

​	The instruction pointer (IP) contains the address of the currently-executing instruction in a machine language program.

***Stack Pointer***

​	The *stack pointer* (SP) contains the address of **the top of the program’s call stack**. Let's assume it grows downward. A data item may be pushed onto the stack by subtracting the size of the item from the value of the stack pointer, and then writing the item at the new address pointed to by SP.