review: 001 009 012 014 015

# Game Engine Architecture

## Computer Hardware Fundamentals

#### Assembly Language

​	In assembly language, each in struction within a given CPU’s ISA is given a *mnemonic*. Instruction operands can be specified conveniently as well: Registers can be referred to by name (e.g. `R0`), and memory addresses can be written in hex. A tool known as an assembler reads the assembly  program source file and converts it into the numeric ML. For example:

```c++
if(a>b)
    return a+b
else
    return 0;
```



``` assembly
cmp eax, ebx	; compare the values
jle ReturnZero	; jump if less than or equal
add eax, ebx	; add & store result in EAX
ret				; (EAX is the return value)
ReturnZero:
	xor eax, eax	; set EAX to zero
	ret				; (EAX is the return value)
```

#### Addressing Modes

​	Addressing modes you will encounter on a real CPU:

- *Register addressing*. This mode allows values to be transferred from one register to another.
- *Immediate addressing*. This mode allows a literal or “immediate” value to be loaded into a register.
- *Direct addressing*. This mode allows data to be moved to or from memory.
- Register indirect addressing. In this mode, the target memory address is taken from a register.
- Relative addressing. In this mode, the target memory address is specified as an operand, and the value stored in a specified register is used as an offset from that target memory address.

## Memory Architectures

### Memory Mapping

​	An individual memory device (ROM or RAM) is always addressed as a contiguous block of memory cells. So a computer’s address space is typically divided into various contiguous segments. Whenever a physical memory device is assigned to a range of addresses in a computer’s address space, we say that the address range has been mapped to the memory device. It’s common for some segments of a computer’s address space to remain unassigned.

#### Memory-Mapped I/O

​	Address ranges needn’t all map to memory devices—an address range might also be mapped to other *peripheral devices*, such as keybord or network interface card(NIC). This approach is called *memory-mapped I/O* because the CPU can perform I/O operations on a peripheral device by reading or writing to addresses. Special circuitry detects that the CPU is reading from or writing to a range of addresses that have been mapped to a non-memory device, and converts the read or write request into an I/O operation at the device.

​	Alternatively, a CPU might communicate with non-memory devices via special registers known as *ports*. In this case, whenever the CPU requests that data be read from or written to a port register, the hardware converts the request into an I/O operation on the target device. This approach is called *port-mapped I/O*.

#### Video RAM

​	Raster-based display devices typically read a special range of physical memory addresses in order to determine the brightness/color of each pixel on the screen. A range of memory addresses assigned for use by a video controller is known as *video RAM* (VRAM).

​	Game consloles like PlayStation 4 and the Xbox One, where both the CPU and GPU share access to a single, large block of unified memory. In personal computers, video RAM is typically located on the video card so that the GPU can access it as quickly as possible. A bus protocol such as PCIe is used to transfer data back and forth between “main RAM” and VRAM. This physical separation between main RAM and VRAM can be a significant performance bottleneck.

### Virtual Memory

​	Most modern CPUs and operating systems support a memory remapping feature known as a *virtual memory system*. In these systems, the memory addresses used by a program don’t map directly to the memory modules installed in the computer. Instead, whenever a program reads from or writes to an address, that address is first remapped by the CPU via a look-up table that’s maintained by the OS. The remapped address might end up referring to an actual cell in memory. It might also end up referring to a block of data on-disk. Or it might turn out not to be mapped to any physical storage at all.

​	Virtual memory improves the stability and security of the operating system, because each program has its own private “view” of memory.

#### Virtual Memory Pages

​	The entire addressable memory space ($2^n$ byte-sized cells if the address bus is $n$ bits wide) is conceptually divided into **equally-sized** contiguous chunks known as *pages*. Page sizes differ from OS to OS, but are always a power of two.

#### Virtual to Physical Address Translation

​	Whenever the CPU detects a memory read or write operation, the address is split into two parts: the *page index* and an *offset* within that page. For a page size of $4$ KiB(address bus is $32$ bits wide), the offset is just the lower $12$ bits of the address, and the page index is the upper $20$ bits.

​	The page index is then looked up by the CPU’s *memory management unit* (MMU) in a page table that maps virtual page indices to physical ones. (The page table is stored in RAM and is managed by the operating system.) Together with the bits of the original page offset, we can get physical address.

![image-20220826141233605](C:\Users\Clan\OneDrive\桌面\study\研一\studys\day by day\pictures\image-20220826141233605.png)

​	If the page table indicates that a page is not mapped to physical RAM, the MMU raises an interrupt, which tells the oper ating system that the memory request can’t be fulfilled. This is called a *page fault*.

#### Handling Page Faults

​	For accesses to unallocated pages, the OS normally responds to a page fault by crashing the program and *generating a core dump*. For accesses to pages that have been swapped out to disk, the OS temporarily suspends the currently running program, reads the page from the swap file into a physical page of RAM, and then translates the virtual address to a physical address as usual.

​	Normally pages are swapped out to disk only when the load on the memory system is high, and physical pages are in short supply. The OS tries to swap out only the least-frequently-used pages of memory.

#### The Translation Lookaside Buffer (TLB)

​	Because page sizes tend to be small relative to the total size of addressable memory (typically 4 KiB or 8 KiB), the page table can become very large. Looking up physical addresses in the page table would be time-consuming if the entire table had to be scanned for every memory access a program makes.

​	Based on twenty-eighty rule,  a small table known as the *translation lookaside buffer* (TLB) is maintained within the MMU on the CPU, in which the virtual-to-physical address mappings of the most recently-used addresses are cached.

### Memory Architectures for Latency Reduction

​	We often speak of *memory access latency*, which is defined as the length of time between the moment the CPU requests data from the memory system and the moment that that data is actually received by the CPU. Memory access latency is primarily dependent on three factors:

1. the technology used to implement the individual memory cells. (SRAM is better than DRAM)
2. the number of read and/or write ports supported by the memory. (Multi-ported RAM is better than single port RAM)
3. the physical distance between those memory cells and the CPU core.

# C++ Primer

- 当`auto`与`begin`或`end`结合使用时，获得的迭代器类型依赖于容器类型，与我们想要如何使用迭代器毫不相干。
- 当不需要写访问时，应使用`cbegin`与`cend`
- 定义一个`array`时，除了指定元素类型，还需要指定容器大小`array<int, 10>`
- 如果我们对`array`进行列表初始化，初始值数量必须小于等于`array`的大小，并从前面的元素开始初始化。
- 只有当元素类型也定义了相应的比较运算符时，我们才可以使用关系运算符来比较两个容器。
- 当我们将一个对象插入（`push_back`、`push_front`、`insert`）容器时，实际上放入到容器中的时对象值的一个拷贝。
- `emplace`函数（`emplace_back`、`emplace_front`、`emplace`）在容器中直接构造元素。传递给`emplace`函数的参数必须与元素类型的构造函数相匹配。
- `c.front()`返回容器首元素的引用，`c.back()`返回容器尾元素的引用，`c.at(n)`越界时会抛出异常。
- 对空容器使用`front()`和`back()`也属于下标越界错误。
- 当容器不得不分配新空间时，需要将已有元素从旧位置移动到新空间中，再释放旧空间。`capacity`成倍增长。
- `c.resize()`不会改变已经在容器中的元素的值
- `c.shrink_to_fit()` 将`capacity`减少为与`size`一样大。只是请求，并不一定保证。
- `c.reserve(n)`分配至少能容纳n个元素的内存（`capacity`）空间。只有n大于当前`capacity`时才有效。